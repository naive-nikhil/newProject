<script>
  import Lenis from '@studio-freight/lenis';
  import { gsap } from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  // 1. Initialize Lenis
  const lenis = new Lenis({
    duration: 1.2,
    easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)), // Exponential easing for smoother feel
    direction: 'vertical',
    gestureDirection: 'vertical',
    smooth: true,
    mouseMultiplier: 1,
    smoothTouch: true, // IMPORTANT: Enables smooth scrolling on mobile
    touchMultiplier: 2, // Increases mobile sensitivity
  });

  // 2. Connect Lenis to ScrollTrigger
  // Tell ScrollTrigger to use Lenis's scroll info instead of the native window
  lenis.on('scroll', ScrollTrigger.update);

  // 3. The "Flicker" Fix: Sync GSAP Ticker
  // Instead of using requestAnimationFrame, we plug Lenis into GSAP's ticker.
  // This ensures they update in the exact same frame, preventing the "blink".
  gsap.ticker.add((time) => {
    lenis.raf(time * 1000); // GSAP gives time in seconds, Lenis needs ms
  });

  // 4. Disable GSAP's lag smoothing
  // This prevents GSAP from "jumping" when the thread is heavy (like during a scrollbar click)
  gsap.ticker.lagSmoothing(0);

  // 5. Smooth Anchor Links
  document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
    anchor.addEventListener('click', (e) => {
      e.preventDefault();
      const href = anchor.getAttribute('href');
      if (href) {
        const target = document.querySelector(href);
        if (target) {
          lenis.scrollTo(target, {
            offset: 0,
            immediate: false,
            duration: 1.5, // Slower duration for visual smoothness
          });
        }
      }
    });
  });
</script>

<style is:global>
  /* Essential CSS for Lenis & ScrollTrigger Stability */
  
  html.lenis, html.lenis body {
    height: auto;
  }

  .lenis.lenis-smooth {
    scroll-behavior: auto !important; /* Disables native smooth scroll to avoid conflicts */
  }

  /* Prevents the "white flash" on overscroll (especially on Mac/Mobile) */
  html, body {
    width: 100%;
    min-height: 100%;
    overscroll-behavior: none; 
  }

  .lenis.lenis-smooth [data-lenis-prevent] {
    overscroll-behavior: contain;
  }

  .lenis.lenis-stopped {
    overflow: hidden;
  }

  .lenis.lenis-scrolling iframe {
    pointer-events: none; /* Improves performance while scrolling */
  }
</style>