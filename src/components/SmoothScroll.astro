---

---

<script>
  import Lenis from '@studio-freight/lenis';
  import { gsap } from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  // Register GSAP plugins
  gsap.registerPlugin(ScrollTrigger);

  // Detect mobile devices
  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;

  // Initialize Lenis with better mobile support
  const lenis = new Lenis({
    duration: isMobile ? 1.5 : 2,
    easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
    orientation: 'vertical',
    gestureOrientation: 'vertical',
    smoothWheel: true,
    wheelMultiplier: isMobile ? 0.8 : 1,
    touchMultiplier: isMobile ? 1.5 : 2,
    infinite: false,
    syncTouch: true,
    syncTouchLerp: 0.075,
  });

  // Connect Lenis with GSAP ScrollTrigger
  lenis.on('scroll', ScrollTrigger.update);

  gsap.ticker.add((time) => {
    lenis.raf(time * 1000);
  });

  gsap.ticker.lagSmoothing(0);

  // Handle scrollbar track clicks smoothly
  let isScrolling = false;
  let scrollTimeout: ReturnType<typeof setTimeout>;

  const handleScrollbarClick = (e: MouseEvent) => {
    if (isScrolling) return;
    
    // Check if click is on scrollbar track area
    const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
    const clickX = e.clientX;
    
    // Only handle if click is in the scrollbar area (right side of viewport)
    if (scrollbarWidth > 0 && clickX >= window.innerWidth - scrollbarWidth) {
      const scrollContainer = document.documentElement;
      const clickY = e.clientY;
      const viewportHeight = window.innerHeight;
      const scrollPercentage = clickY / viewportHeight;
      const maxScroll = scrollContainer.scrollHeight - viewportHeight;
      const targetScroll = scrollPercentage * maxScroll;
      
      isScrolling = true;
      lenis.scrollTo(targetScroll, {
        duration: 1.2,
        easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
        onComplete: () => {
          clearTimeout(scrollTimeout);
          scrollTimeout = setTimeout(() => {
            isScrolling = false;
          }, 100);
        }
      });
      
      e.preventDefault();
      e.stopPropagation();
    }
  };

  // Handle scrollbar track clicks
  document.addEventListener('mousedown', (e: MouseEvent) => {
    if (e.button === 0) { // Left click only
      handleScrollbarClick(e);
    }
  }, { passive: false });

  // Example GSAP ScrollTrigger animations
  gsap.utils.toArray('.fade-in').forEach((element: any) => {
    gsap.from(element, {
      scrollTrigger: {
        trigger: element,
        start: 'top 80%',
        end: 'top 20%',
        scrub: true,
      },
      opacity: 0,
      y: 50,
    });
  });

  // Smooth scroll to anchor links
  document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
    anchor.addEventListener('click', (e: Event) => {
      e.preventDefault();
      const href = (anchor as HTMLAnchorElement).getAttribute('href');
      if (href) {
        const target = document.querySelector(href);
        if (target) {
          lenis.scrollTo(target as HTMLElement, {
            offset: 0,
            duration: 1.5,
          });
        }
      }
    });
  });

  // Cleanup on page unload
  window.addEventListener('beforeunload', () => {
    lenis.destroy();
  });
</script>

<style is:global>
  html.lenis {
    height: auto;
  }

  .lenis.lenis-smooth {
    scroll-behavior: auto !important;
  }

  .lenis.lenis-smooth [data-lenis-prevent] {
    overscroll-behavior: contain;
  }

  .lenis.lenis-stopped {
    overflow: hidden;
  }

  .lenis.lenis-scrolling iframe {
    pointer-events: none;
  }

  /* Improve scrollbar behavior */
  * {
    scrollbar-width: thin;
    scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
  }

  *::-webkit-scrollbar {
    width: 8px;
  }

  *::-webkit-scrollbar-track {
    background: transparent;
  }

  *::-webkit-scrollbar-thumb {
    background-color: rgba(255, 255, 255, 0.2);
    border-radius: 4px;
    transition: background-color 0.2s;
  }

  *::-webkit-scrollbar-thumb:hover {
    background-color: rgba(255, 255, 255, 0.3);
  }

  /* Prevent scrollbar click jank */
  body {
    -webkit-overflow-scrolling: touch;
  }

  @media (max-width: 768px) {
    * {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    *::-webkit-scrollbar {
      display: none;
    }
  }
</style>