<script>
  import Lenis from '@studio-freight/lenis';
  import { gsap } from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  // Detect mobile devices
  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;

  let lenis = null;

  if (!isMobile) {
    // Only initialize Lenis on desktop for smooth scrolling
    lenis = new Lenis({
      duration: 1.2,
      easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
      direction: 'vertical',
      gestureDirection: 'vertical',
      smooth: true,
      mouseMultiplier: 1,
    });

    // Connect Lenis to ScrollTrigger
    lenis.on('scroll', ScrollTrigger.update);

    // Sync GSAP Ticker
    gsap.ticker.add((time) => {
      lenis.raf(time * 1000);
    });

    // Disable GSAP's lag smoothing
    gsap.ticker.lagSmoothing(0);
  } else {
    // On mobile, use native scrolling and just connect ScrollTrigger
    ScrollTrigger.refresh();
  }

  // Smooth Anchor Links (works on both mobile and desktop)
  document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
    anchor.addEventListener('click', (e) => {
      e.preventDefault();
      const href = anchor.getAttribute('href');
      if (href) {
        const target = document.querySelector(href);
        if (target) {
          if (lenis) {
            // Use Lenis on desktop
            lenis.scrollTo(target, {
              offset: 0,
              immediate: false,
              duration: 1.5,
            });
          } else {
            // Use native smooth scroll on mobile
            target.scrollIntoView({
              behavior: 'smooth',
              block: 'start',
            });
          }
        }
      }
    });
  });
</script>

<style is:global>
  /* Essential CSS for Lenis & ScrollTrigger Stability */
  
  html.lenis, html.lenis body {
    height: auto;
  }

  .lenis.lenis-smooth {
    scroll-behavior: auto !important; /* Disables native smooth scroll to avoid conflicts */
  }

  /* Mobile-friendly scrolling */
  html, body {
    width: 100%;
    min-height: 100%;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
  }

  /* Only apply overscroll-behavior on desktop */
  @media (min-width: 769px) {
    html, body {
      overscroll-behavior: none;
    }
  }

  .lenis.lenis-smooth [data-lenis-prevent] {
    overscroll-behavior: contain;
  }

  .lenis.lenis-stopped {
    overflow: hidden;
  }

  .lenis.lenis-scrolling iframe {
    pointer-events: none; /* Improves performance while scrolling */
  }

  /* Ensure mobile can scroll */
  @media (max-width: 768px) {
    body {
      position: relative;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
  }
</style>